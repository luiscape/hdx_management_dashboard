<!doctype html>
<html lang="en" class="csstransforms csstransforms3d csstransitions js cssanimations csstransitions">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>HDX API Prototype</title>

  	<!-- Loading Source Sans Pro -->
	<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet" type="text/css" />
	<link rel='stylesheet' id='SourceSansPro-css'  href='https://fonts.googleapis.com/css?family=Source+Sans+Pro%3A200%2C400&#038;ver=3.9.1' type='text/css' media='all' />
	<!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

	<!-- Loading C3 + D3 JavaScript -->	
	<script src="/dnv1xak/6gemw2mellxy2t1/http/js/d3.min.js"></script>
	<script src='/dnv1xak/6gemw2mellxy2t1/http/js/c3.js'></script>
	<script src='/dnv1xak/6gemw2mellxy2t1/http/js/jsonpath.js'></script>
	<link href='/dnv1xak/6gemw2mellxy2t1/http/css/c3.css' rel='stylesheet' />


	<link rel='stylesheet' id='bean-css'  href='/dnv1xak/6gemw2mellxy2t1/http/css/framework.css' type='text/css' media='all' />
	<link rel='stylesheet' id='main-style-css'  href='/dnv1xak/6gemw2mellxy2t1/http/css/style.css' type='text/css' media='all' />
	<link rel='stylesheet' id='mobile-css'  href='/dnv1xak/6gemw2mellxy2t1/http/css/mobile.css' type='text/css' media='all' />
	<link rel='stylesheet' id='font-awesome-four-css'  href='/dnv1xak/6gemw2mellxy2t1/http/css/font-awesome.min.css' type='text/css' media='all' />
	<script type='text/javascript' src='/dnv1xak/6gemw2mellxy2t1/http/js/jquery.js'></script>
	<script type='text/javascript' src='/dnv1xak/6gemw2mellxy2t1/http/js/jquery-migrate.min.js'></script>
	<style type="text/css" id="custom-background-css">
		body.custom-background {
			/* background-image: url('http://docs.hdx.rwlabs.org/wp-content/uploads/worldmap.png'); */
			background-color: #fff;
			background-repeat: no-repeat;
			background-position: top center;
			background-attachment: fixed;
		}
		.archive div#main,
		.blog div#main-container {
			float: none;
			padding-top: 250px;
			padding-left: 100px;
			padding-bottom: 100px;
			padding-right: 100px;
			background-color: #fff;
		}
		a.more-link,
		.entry-content a.more-link {
			background-color: #808080;
		}
	</style>
</head>

<body class="archive category category-blog category-12 custom-background chrome group-blog">
<section id='main-container' class="BlogFrontPage clear animated BeanFadeIn">
<div id="main" class="eleven columns" role="main">
        <div class="row">
          <section class=''>
            <section>
              <h4>CKAN Indicators</h4>
            </section>
            <section>
            	<div class="twelve columns">
            	<h2></p>
            	<div id="indicators_select">
            		<form action="">
            			<select id="indicators_dropdown" name="indicators_dropdown" onchange="refreshChart()">
				</select>
				<button type="button" onclick="refreshChart()">Refresh Chart</button>
            		</form>
            	</div>
            	<hr />
            		<div id="n_datasets"></div>
            	</div>
            </section>
            <section>
            </section>
          </section>

        </div>

        <footer>
        	<p>Developed by <a href="http://www.github.com/luiscape">@luiscape</a> and <a href="http://www.github.com/takavarasha">@takavarasha</a></p>
        </footer>
</div>
</section>
</body>
<style>
#n_datasets .c3-line {
  stroke-width: 2px;
}
#n_datasets .c3-legend-item {
font-size: 11px;
}
</style>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
<script>

var apiURL = "https://ds-ec2.scraperwiki.com/dnv1xak/6gemw2mellxy2t1/sql?q=Select * From Indicators";
$.getJSON(apiURL, function( data ) {
  for(var i = 0; i < data.length; i++) {
    var indicator = data[i];
	var option = document.createElement("option");
	option.text = indicator["name"];
	option.value = indicator["indID"];
	document.getElementById("indicators_dropdown").appendChild(option);
    	// console.log(indicator);
   };
});

function refreshChart() {
	// code for generating a simple time series.
    // here we are querying the API and parsing the
    // results into json arrays. those arrays contain
    // the data that will be charted.
	var indicatorsDropDown = document.getElementById("indicators_dropdown");
	var selectedIndicator = indicatorsDropDown.value;
	var indicatorName = indicatorsDropDown.options[indicatorsDropDown.selectedIndex].text;
	console.log(indicatorName);
	console.log(String(indicatorName));
	d3.json("https://ds-ec2.scraperwiki.com/dnv1xak/6gemw2mellxy2t1/sql?q=select * from Observations Where indID='" + selectedIndicator + "'", function(error, json) {
		if (error) return console.warn(error);
		data = json;

		var value, period;
		value = jsonPath.eval(data, '$..value');
		period = jsonPath.eval(data, '$..period');

		var format = d3.time.format("%Y-%m-%d");
		var years = [];
		function getDate(element, index, array) {
		   years.push(format.parse(String(element)));
		}
		period.forEach(getDate);

		var n_datasets = c3.generate({
		  	bindto: '#n_datasets',
		  	data: {
		  		x: 'year',
		  		// x_format: '%Y',
		  		json: {
			  		year: years,
		      		n_datasets: value
		  		},
		  		type: 'line',
		  		names: {
		  			year: 'Date',
		  			n_datasets: indicatorName
		  		}
		  	},
		  	bar: {
		  		width: {
		  			ratio: 0.99
		  		}
		  	},
		  	axis: {
		        x: {
		          type: 'timeseries',
		          tick: {
		          	format: '%Y-%m-%d'
		          }
		        },
		        y: {
		        	show: false
		        }
		    }
         });
    });
};

</script>
</html>
